# ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆå’Œç­–ç•¥ - é¢è¯•å¿…å¤‡

## ğŸ“‹ ç›®å½•
- [ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æ¦‚è¿°](#ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æ¦‚è¿°)
- [å¸¸è§çš„ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆ](#å¸¸è§çš„ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆ)
- [ç¼“å­˜æ›´æ–°ç­–ç•¥](#ç¼“å­˜æ›´æ–°ç­–ç•¥)
- [åˆ†å¸ƒå¼ç¼“å­˜ä¸€è‡´æ€§](#åˆ†å¸ƒå¼ç¼“å­˜ä¸€è‡´æ€§)
- [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯)
- [é¢è¯•å¸¸è§é—®é¢˜](#é¢è¯•å¸¸è§é—®é¢˜)

## ğŸ¯ ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Ÿ

ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æ˜¯æŒ‡ç¼“å­˜ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¸»è¦è¡¨ç°ä¸ºï¼š

1. **æ•°æ®ä¸ä¸€è‡´**ï¼šç¼“å­˜å’Œæ•°æ®åº“ä¸­çš„æ•°æ®å€¼ä¸åŒ
2. **æ—¶æ•ˆæ€§é—®é¢˜**ï¼šç¼“å­˜ä¸­çš„æ•°æ®å·²è¿‡æœŸä½†ä»è¢«ä½¿ç”¨
3. **å¹¶å‘é—®é¢˜**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶æ“ä½œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´

### äº§ç”ŸåŸå› 

```java
// å…¸å‹çš„ç¼“å­˜ä¸ä¸€è‡´åœºæ™¯
public class UserService {
    
    // åœºæ™¯1ï¼šå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜
    public void updateUser(User user) {
        // 1. æ›´æ–°æ•°æ®åº“
        userDao.update(user);
        
        // 2. åˆ é™¤ç¼“å­˜ - å¦‚æœè¿™æ­¥å¤±è´¥ï¼Œå°±ä¼šå‡ºç°ä¸ä¸€è‡´
        redisTemplate.delete("user:" + user.getId());
    }
    
    // åœºæ™¯2ï¼šå¹¶å‘è¯»å†™å¯¼è‡´çš„ä¸ä¸€è‡´
    public User getUser(Long userId) {
        String key = "user:" + userId;
        User user = redisTemplate.get(key);
        
        if (user == null) {
            // ä»æ•°æ®åº“æŸ¥è¯¢
            user = userDao.findById(userId);
            if (user != null) {
                // å†™å…¥ç¼“å­˜ - å¹¶å‘æƒ…å†µä¸‹å¯èƒ½å†™å…¥æ—§æ•°æ®
                redisTemplate.set(key, user, 3600);
            }
        }
        return user;
    }
}
```

## ğŸ”§ å¸¸è§çš„ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆ

### 1. Cache Aside Patternï¼ˆæ—è·¯ç¼“å­˜ï¼‰

**è¯»æ“ä½œæµç¨‹ï¼š**
```java
public User getUserById(Long userId) {
    String key = "user:" + userId;
    
    // 1. å…ˆæŸ¥ç¼“å­˜
    User user = redisTemplate.opsForValue().get(key);
    if (user != null) {
        return user;
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
    user = userDao.findById(userId);
    if (user != null) {
        // 3. å†™å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(key, user, Duration.ofHours(1));
    }
    
    return user;
}
```

**å†™æ“ä½œæµç¨‹ï¼š**
```java
public void updateUser(User user) {
    // æ–¹æ¡ˆ1ï¼šå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼ˆæ¨èï¼‰
    userDao.update(user);
    redisTemplate.delete("user:" + user.getId());
    
    // æ–¹æ¡ˆ2ï¼šå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“
    // redisTemplate.delete("user:" + user.getId());
    // userDao.update(user);
}
```

### 2. Write Through Patternï¼ˆå†™ç©¿é€ï¼‰

```java
@Service
public class CacheWriteThroughService {
    
    public void updateUser(User user) {
        // åŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
        CompletableFuture<Void> dbUpdate = CompletableFuture.runAsync(() -> {
            userDao.update(user);
        });
        
        CompletableFuture<Void> cacheUpdate = CompletableFuture.runAsync(() -> {
            redisTemplate.opsForValue().set("user:" + user.getId(), user);
        });
        
        // ç­‰å¾…ä¸¤ä¸ªæ“ä½œéƒ½å®Œæˆ
        CompletableFuture.allOf(dbUpdate, cacheUpdate).join();
    }
}
```

### 3. Write Behind Patternï¼ˆå†™å›ï¼‰

```java
@Component
public class WriteBehindCache {
    
    private final Map<String, Object> writeBuffer = new ConcurrentHashMap<>();
    
    @Scheduled(fixedDelay = 5000) // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
    public void flushToDatabase() {
        if (!writeBuffer.isEmpty()) {
            Map<String, Object> toFlush = new HashMap<>(writeBuffer);
            writeBuffer.clear();
            
            // æ‰¹é‡å†™å…¥æ•°æ®åº“
            batchUpdateDatabase(toFlush);
        }
    }
    
    public void updateUser(User user) {
        // ç«‹å³æ›´æ–°ç¼“å­˜
        String key = "user:" + user.getId();
        redisTemplate.opsForValue().set(key, user);
        
        // åŠ å…¥å†™ç¼“å†²åŒºï¼Œå»¶è¿Ÿå†™å…¥æ•°æ®åº“
        writeBuffer.put(key, user);
    }
}
```

## ğŸ”„ ç¼“å­˜æ›´æ–°ç­–ç•¥

### 1. å»¶è¿ŸåŒåˆ ç­–ç•¥

```java
public void updateUserWithDelayedDoubleDelete(User user) {
    // ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜
    redisTemplate.delete("user:" + user.getId());
    
    // æ›´æ–°æ•°æ®åº“
    userDao.update(user);
    
    // å»¶è¿Ÿåˆ é™¤ç¼“å­˜
    CompletableFuture.runAsync(() -> {
        try {
            Thread.sleep(1000); // å»¶è¿Ÿ1ç§’
            redisTemplate.delete("user:" + user.getId());
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    });
}
```

### 2. åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥æ›´æ–°

```java
@Service
public class AsyncCacheUpdateService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void updateUser(User user) {
        // æ›´æ–°æ•°æ®åº“
        userDao.update(user);
        
        // å‘é€ç¼“å­˜æ›´æ–°æ¶ˆæ¯
        CacheUpdateMessage message = new CacheUpdateMessage();
        message.setKey("user:" + user.getId());
        message.setOperation("DELETE");
        
        rabbitTemplate.convertAndSend("cache.update.exchange", 
                                    "cache.update.routing.key", 
                                    message);
    }
    
    @RabbitListener(queues = "cache.update.queue")
    public void handleCacheUpdate(CacheUpdateMessage message) {
        if ("DELETE".equals(message.getOperation())) {
            redisTemplate.delete(message.getKey());
        }
    }
}
```

### 3. åŸºäºç‰ˆæœ¬å·çš„ä¹è§‚é”

```java
@Entity
public class User {
    @Id
    private Long id;
    private String name;
    private String email;
    
    @Version
    private Long version; // ç‰ˆæœ¬å·
    
    // getters and setters
}

@Service
public class OptimisticLockCacheService {
    
    public void updateUser(User user) {
        String key = "user:" + user.getId();
        
        try {
            // æ›´æ–°æ•°æ®åº“ï¼ˆä¹è§‚é”ï¼‰
            int updated = userDao.updateWithVersion(user);
            
            if (updated > 0) {
                // æ›´æ–°æˆåŠŸï¼Œåˆ é™¤ç¼“å­˜
                redisTemplate.delete(key);
            } else {
                // æ›´æ–°å¤±è´¥ï¼Œç‰ˆæœ¬å†²çª
                throw new OptimisticLockException("æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹");
            }
        } catch (OptimisticLockException e) {
            // å¤„ç†ç‰ˆæœ¬å†²çª
            redisTemplate.delete(key); // åˆ é™¤å¯èƒ½è¿‡æœŸçš„ç¼“å­˜
            throw e;
        }
    }
}
```

## ğŸŒ åˆ†å¸ƒå¼ç¼“å­˜ä¸€è‡´æ€§

### 1. åŸºäºRedisçš„åˆ†å¸ƒå¼é”

```java
@Component
public class DistributedCacheConsistency {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void updateUserWithDistributedLock(User user) {
        String lockKey = "lock:user:" + user.getId();
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–åˆ†å¸ƒå¼é”
            Boolean acquired = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(30));
            
            if (acquired) {
                // æ›´æ–°æ•°æ®åº“
                userDao.update(user);
                
                // åˆ é™¤ç¼“å­˜
                redisTemplate.delete("user:" + user.getId());
            } else {
                throw new RuntimeException("è·å–é”å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            }
        } finally {
            // é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    }
    
    private void releaseLock(String lockKey, String lockValue) {
        String script = "if redis.call('get', KEYS[1]) == ARGV[1] then " +
                       "return redis.call('del', KEYS[1]) else return 0 end";
        
        redisTemplate.execute(new DefaultRedisScript<>(script, Long.class),
                            Collections.singletonList(lockKey), lockValue);
    }
}
```

### 2. åŸºäºCanalçš„æ•°æ®åŒæ­¥

```java
@Component
public class CanalCacheSync {
    
    @EventListener
    public void handleDatabaseChange(CanalEntry.Entry entry) {
        if (entry.getEntryType() == CanalEntry.EntryType.ROWDATA) {
            CanalEntry.RowChange rowChange = CanalEntry.RowChange.parseFrom(entry.getStoreValue());
            
            for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) {
                if (rowChange.getEventType() == CanalEntry.EventType.UPDATE ||
                    rowChange.getEventType() == CanalEntry.EventType.DELETE) {
                    
                    // è§£æä¸»é”®
                    String primaryKey = extractPrimaryKey(rowData);
                    
                    // åˆ é™¤å¯¹åº”çš„ç¼“å­˜
                    String cacheKey = "user:" + primaryKey;
                    redisTemplate.delete(cacheKey);
                    
                    log.info("ç¼“å­˜å·²åˆ é™¤: {}", cacheKey);
                }
            }
        }
    }
}
```

## ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šç”µå•†å•†å“ä¿¡æ¯ç¼“å­˜

```java
@Service
public class ProductCacheService {
    
    // å•†å“ä¿¡æ¯æŸ¥è¯¢
    public Product getProduct(Long productId) {
        String key = "product:" + productId;
        
        // 1. æŸ¥è¯¢ç¼“å­˜
        Product product = redisTemplate.opsForValue().get(key);
        if (product != null) {
            return product;
        }
        
        // 2. æŸ¥è¯¢æ•°æ®åº“
        product = productDao.findById(productId);
        if (product != null) {
            // 3. å†™å…¥ç¼“å­˜ï¼Œè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´é¿å…ç¼“å­˜é›ªå´©
            int expireTime = 3600 + new Random().nextInt(600); // 1-1.1å°æ—¶
            redisTemplate.opsForValue().set(key, product, Duration.ofSeconds(expireTime));
        }
        
        return product;
    }
    
    // å•†å“ä¿¡æ¯æ›´æ–°
    @Transactional
    public void updateProduct(Product product) {
        // 1. æ›´æ–°æ•°æ®åº“
        productDao.update(product);
        
        // 2. åˆ é™¤ç›¸å…³ç¼“å­˜
        String productKey = "product:" + product.getId();
        String categoryKey = "category:products:" + product.getCategoryId();
        
        redisTemplate.delete(productKey);
        redisTemplate.delete(categoryKey);
        
        // 3. å‘é€ç¼“å­˜æ›´æ–°äº‹ä»¶
        applicationEventPublisher.publishEvent(new ProductUpdatedEvent(product.getId()));
    }
}
```

### åœºæ™¯2ï¼šç”¨æˆ·ä¼šè¯ç¼“å­˜

```java
@Service
public class UserSessionCacheService {
    
    public void updateUserSession(String sessionId, UserSession session) {
        String key = "session:" + sessionId;
        
        // ä½¿ç”¨Redisäº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§
        redisTemplate.execute(new SessionCallback<Object>() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                operations.multi();
                
                // æ›´æ–°ä¼šè¯ä¿¡æ¯
                operations.opsForValue().set(key, session, Duration.ofMinutes(30));
                
                // æ›´æ–°ç”¨æˆ·æ´»è·ƒæ—¶é—´
                operations.opsForValue().set("user:last_active:" + session.getUserId(), 
                                           System.currentTimeMillis());
                
                return operations.exec();
            }
        });
    }
}
```

## â“ é¢è¯•å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ¨è"å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"ï¼Ÿ

**ç­”æ¡ˆï¼š**
- **æ•°æ®ä¸€è‡´æ€§æ›´å¥½**ï¼šå³ä½¿åˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢ä¼šä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®
- **å¹¶å‘å®‰å…¨æ€§**ï¼šå‡å°‘äº†è„æ•°æ®å†™å…¥ç¼“å­˜çš„æ¦‚ç‡
- **ç®€å•å¯é **ï¼šå®ç°ç®€å•ï¼Œå‡ºé”™æ¦‚ç‡è¾ƒä½

### Q2: å¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Ÿ

**ç­”æ¡ˆï¼š**
```java
public Object getDataWithMutex(String key) {
    // 1. æŸ¥è¯¢ç¼“å­˜
    Object data = redisTemplate.opsForValue().get(key);
    if (data != null) {
        return data;
    }
    
    // 2. è·å–äº’æ–¥é”
    String lockKey = "lock:" + key;
    try {
        Boolean acquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, "1", Duration.ofSeconds(10));
        
        if (acquired) {
            // 3. åŒé‡æ£€æŸ¥
            data = redisTemplate.opsForValue().get(key);
            if (data != null) {
                return data;
            }
            
            // 4. æŸ¥è¯¢æ•°æ®åº“
            data = queryFromDatabase(key);
            
            // 5. å†™å…¥ç¼“å­˜
            if (data != null) {
                redisTemplate.opsForValue().set(key, data, Duration.ofHours(1));
            }
        } else {
            // ç­‰å¾…å…¶ä»–çº¿ç¨‹åŠ è½½æ•°æ®
            Thread.sleep(100);
            return getDataWithMutex(key); // é€’å½’è°ƒç”¨
        }
    } finally {
        redisTemplate.delete(lockKey);
    }
    
    return data;
}
```

### Q3: å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç¼“å­˜ä¸€è‡´æ€§ï¼Ÿ

**ç­”æ¡ˆï¼š**
1. **ä½¿ç”¨åˆ†å¸ƒå¼é”**ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æ›´æ–°ç¼“å­˜
2. **æ¶ˆæ¯é˜Ÿåˆ—é€šçŸ¥**ï¼šé€šè¿‡MQé€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹æ›´æ–°ç¼“å­˜
3. **ç‰ˆæœ¬å·æœºåˆ¶**ï¼šä½¿ç”¨ç‰ˆæœ¬å·æ£€æµ‹æ•°æ®å˜æ›´
4. **æœ€ç»ˆä¸€è‡´æ€§**ï¼šæ¥å—çŸ­æš‚çš„ä¸ä¸€è‡´ï¼Œé€šè¿‡å®šæ—¶ä»»åŠ¡ä¿®å¤

### Q4: ç¼“å­˜é›ªå´©å¦‚ä½•é¢„é˜²å’Œè§£å†³ï¼Ÿ

**ç­”æ¡ˆï¼š**
```java
@Service
public class CacheAvalanchePrevention {

    // æ–¹æ¡ˆ1ï¼šè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
    public void setWithRandomExpire(String key, Object value) {
        int baseExpire = 3600; // åŸºç¡€è¿‡æœŸæ—¶é—´1å°æ—¶
        int randomExpire = new Random().nextInt(600); // éšæœº0-10åˆ†é’Ÿ

        redisTemplate.opsForValue().set(key, value,
            Duration.ofSeconds(baseExpire + randomExpire));
    }

    // æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜
    public Object getDataWithMultiLevel(String key) {
        // L1ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜
        Object data = localCache.get(key);
        if (data != null) {
            return data;
        }

        // L2ç¼“å­˜ï¼šRedis
        data = redisTemplate.opsForValue().get(key);
        if (data != null) {
            localCache.put(key, data, 300); // æœ¬åœ°ç¼“å­˜5åˆ†é’Ÿ
            return data;
        }

        // L3ï¼šæ•°æ®åº“
        data = queryFromDatabase(key);
        if (data != null) {
            setWithRandomExpire(key, data);
            localCache.put(key, data, 300);
        }

        return data;
    }
}
```

### Q5: å¦‚ä½•å¤„ç†çƒ­ç‚¹æ•°æ®çš„ç¼“å­˜ä¸€è‡´æ€§ï¼Ÿ

**ç­”æ¡ˆï¼š**
```java
@Service
public class HotDataCacheService {

    // çƒ­ç‚¹æ•°æ®æ ‡è¯†
    private final Set<String> hotKeys = ConcurrentHashMap.newKeySet();

    public void updateHotData(String key, Object data) {
        if (hotKeys.contains(key)) {
            // çƒ­ç‚¹æ•°æ®ä½¿ç”¨å†™æ—¶å¤åˆ¶ç­–ç•¥
            String tempKey = key + ":temp:" + System.currentTimeMillis();

            // 1. å†™å…¥ä¸´æ—¶key
            redisTemplate.opsForValue().set(tempKey, data, Duration.ofMinutes(5));

            // 2. åŸå­æ€§æ›¿æ¢
            String script =
                "redis.call('del', KEYS[1]) " +
                "redis.call('rename', KEYS[2], KEYS[1]) " +
                "return 1";

            redisTemplate.execute(new DefaultRedisScript<>(script, Long.class),
                Arrays.asList(key, tempKey));
        } else {
            // æ™®é€šæ•°æ®ç›´æ¥æ›´æ–°
            redisTemplate.opsForValue().set(key, data);
        }
    }
}
```

### Q6: å»¶è¿ŸåŒåˆ ç­–ç•¥çš„å»¶è¿Ÿæ—¶é—´å¦‚ä½•ç¡®å®šï¼Ÿ

**ç­”æ¡ˆï¼š**
å»¶è¿Ÿæ—¶é—´éœ€è¦å¤§äºä¸€æ¬¡æ•°æ®åº“è¯»æ“ä½œçš„æ—¶é—´ï¼Œé€šå¸¸è®¾ç½®ä¸ºï¼š
- **è¯»æ“ä½œè€—æ—¶ + ç½‘ç»œå»¶è¿Ÿ + å®‰å…¨è¾¹é™…**
- ä¸€èˆ¬è®¾ç½®ä¸º **500ms - 1s**
- å¯ä»¥é€šè¿‡ç›‘æ§æ•°æ®åº“è¯»æ“ä½œçš„P99å»¶è¿Ÿæ¥ç¡®å®š

```java
// åŠ¨æ€å»¶è¿Ÿæ—¶é—´è®¡ç®—
@Component
public class DynamicDelayCalculator {

    private volatile long delayTime = 1000; // é»˜è®¤1ç§’

    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    public void updateDelayTime() {
        // è·å–æ•°æ®åº“è¯»æ“ä½œçš„P99å»¶è¿Ÿ
        long dbReadP99 = metricsService.getDbReadP99Latency();

        // è®¾ç½®ä¸ºP99å»¶è¿Ÿçš„2å€ï¼Œç¡®ä¿å®‰å…¨
        this.delayTime = Math.max(500, dbReadP99 * 2);
    }

    public long getDelayTime() {
        return delayTime;
    }
}
```

## ğŸ› ï¸ æœ€ä½³å®è·µæ€»ç»“

### 1. é€‰æ‹©åˆé€‚çš„ç¼“å­˜ç­–ç•¥

| åœºæ™¯ | æ¨èç­–ç•¥ | åŸå›  |
|------|----------|------|
| è¯»å¤šå†™å°‘ | Cache Aside | ç®€å•å¯é ï¼Œæ€§èƒ½å¥½ |
| å†™å¤šè¯»å°‘ | Write Behind | å‡å°‘æ•°æ®åº“å‹åŠ› |
| å¼ºä¸€è‡´æ€§è¦æ±‚ | Write Through | ä¿è¯æ•°æ®ä¸€è‡´æ€§ |
| çƒ­ç‚¹æ•°æ® | å¤šçº§ç¼“å­˜ | æé«˜å¯ç”¨æ€§ |

### 2. ç¼“å­˜ä¸€è‡´æ€§æ£€æŸ¥æ¸…å•

- [ ] æ˜¯å¦è€ƒè™‘äº†å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ
- [ ] æ˜¯å¦æœ‰åˆé€‚çš„ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼Ÿ
- [ ] æ˜¯å¦å¤„ç†äº†ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶ï¼Ÿ
- [ ] æ˜¯å¦è€ƒè™‘äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ä¸€è‡´æ€§ï¼Ÿ

### 3. ç›‘æ§å’Œå‘Šè­¦

```java
@Component
public class CacheMonitor {

    private final MeterRegistry meterRegistry;

    public CacheMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }

    public Object getWithMonitoring(String key) {
        Timer.Sample sample = Timer.start(meterRegistry);

        try {
            Object data = redisTemplate.opsForValue().get(key);

            if (data != null) {
                meterRegistry.counter("cache.hit", "key", key).increment();
            } else {
                meterRegistry.counter("cache.miss", "key", key).increment();
            }

            return data;
        } finally {
            sample.stop(Timer.builder("cache.access.time")
                .tag("key", key)
                .register(meterRegistry));
        }
    }
}
```

### 4. æ•…éšœæ¢å¤æœºåˆ¶

```java
@Service
public class CacheRecoveryService {

    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkCacheConsistency() {
        // æ£€æŸ¥å…³é”®ç¼“å­˜çš„ä¸€è‡´æ€§
        List<String> criticalKeys = getCriticalKeys();

        for (String key : criticalKeys) {
            try {
                Object cacheData = redisTemplate.opsForValue().get(key);
                Object dbData = queryFromDatabase(key);

                if (!Objects.equals(cacheData, dbData)) {
                    // å‘ç°ä¸ä¸€è‡´ï¼Œä¿®å¤ç¼“å­˜
                    redisTemplate.opsForValue().set(key, dbData);

                    // è®°å½•æ—¥å¿—
                    log.warn("ç¼“å­˜ä¸ä¸€è‡´å·²ä¿®å¤: key={}", key);

                    // å‘é€å‘Šè­¦
                    alertService.sendAlert("ç¼“å­˜ä¸ä¸€è‡´", key);
                }
            } catch (Exception e) {
                log.error("æ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§å¤±è´¥: key={}", key, e);
            }
        }
    }
}
```

## ğŸ¯ å®æˆ˜ç»éªŒåˆ†äº«

### 1. å¤§å‹ç”µå•†ç³»ç»Ÿçš„ç¼“å­˜ä¸€è‡´æ€§å®è·µ

```java
@Service
public class EcommerceCacheService {

    // å•†å“ä»·æ ¼æ›´æ–° - å¼ºä¸€è‡´æ€§è¦æ±‚
    @Transactional
    public void updateProductPrice(Long productId, BigDecimal newPrice) {
        // 1. ä½¿ç”¨åˆ†å¸ƒå¼é”ç¡®ä¿åŸå­æ€§
        String lockKey = "price_update:" + productId;
        RLock lock = redissonClient.getLock(lockKey);

        try {
            if (lock.tryLock(5, 30, TimeUnit.SECONDS)) {
                // 2. æ›´æ–°æ•°æ®åº“
                productDao.updatePrice(productId, newPrice);

                // 3. åˆ é™¤ç›¸å…³ç¼“å­˜
                List<String> keysToDelete = Arrays.asList(
                    "product:" + productId,
                    "product:price:" + productId,
                    "category:products:" + getProductCategory(productId)
                );

                redisTemplate.delete(keysToDelete);

                // 4. å‘é€ä»·æ ¼å˜æ›´äº‹ä»¶
                eventPublisher.publishEvent(new PriceChangedEvent(productId, newPrice));
            }
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }

    // åº“å­˜æ›´æ–° - æœ€ç»ˆä¸€è‡´æ€§
    public void updateInventory(Long productId, int quantity) {
        // 1. ç«‹å³æ›´æ–°ç¼“å­˜
        String inventoryKey = "inventory:" + productId;
        redisTemplate.opsForValue().increment(inventoryKey, quantity);

        // 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“
        CompletableFuture.runAsync(() -> {
            try {
                inventoryDao.updateQuantity(productId, quantity);
            } catch (Exception e) {
                // æ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œå›æ»šç¼“å­˜
                redisTemplate.opsForValue().increment(inventoryKey, -quantity);
                log.error("åº“å­˜æ›´æ–°å¤±è´¥ï¼Œå·²å›æ»šç¼“å­˜: productId={}", productId, e);
            }
        });
    }
}
```

### 2. é‡‘èç³»ç»Ÿçš„ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆ

```java
@Service
public class FinancialCacheService {

    // è´¦æˆ·ä½™é¢æ›´æ–° - ä¸¥æ ¼ä¸€è‡´æ€§
    @Transactional
    public void updateAccountBalance(String accountId, BigDecimal amount) {
        // 1. å…ˆåˆ é™¤ç¼“å­˜
        String balanceKey = "balance:" + accountId;
        redisTemplate.delete(balanceKey);

        try {
            // 2. æ›´æ–°æ•°æ®åº“
            accountDao.updateBalance(accountId, amount);

            // 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ï¼ˆåŒåˆ ç­–ç•¥ï¼‰
            CompletableFuture.runAsync(() -> {
                try {
                    Thread.sleep(1000);
                    redisTemplate.delete(balanceKey);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });

        } catch (Exception e) {
            // æ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œç¡®ä¿ç¼“å­˜è¢«æ¸…é™¤
            redisTemplate.delete(balanceKey);
            throw e;
        }
    }
}
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”åˆ†æ

| ç­–ç•¥ | ä¸€è‡´æ€§å¼ºåº¦ | æ€§èƒ½å½±å“ | å®ç°å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|------------|----------|------------|----------|
| Cache Aside | ä¸­ç­‰ | ä½ | ä½ | é€šç”¨åœºæ™¯ |
| Write Through | å¼º | ä¸­ç­‰ | ä¸­ç­‰ | å¼ºä¸€è‡´æ€§è¦æ±‚ |
| Write Behind | å¼± | é«˜ | é«˜ | é«˜å¹¶å‘å†™å…¥ |
| å»¶è¿ŸåŒåˆ  | ä¸­ç­‰ | ä½ | ä½ | è¯»å¤šå†™å°‘ |
| åˆ†å¸ƒå¼é” | å¼º | é«˜ | ä¸­ç­‰ | å…³é”®æ•°æ® |

## ğŸš¨ å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ

### 1. ç¼“å­˜ç©¿é€

```java
// é—®é¢˜ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®å¯¼è‡´ç¼“å­˜ç©¿é€
public User getUserById(Long userId) {
    String key = "user:" + userId;
    User user = redisTemplate.opsForValue().get(key);

    if (user == null) {
        user = userDao.findById(userId);
        if (user == null) {
            // è§£å†³æ–¹æ¡ˆï¼šç¼“å­˜ç©ºå€¼
            redisTemplate.opsForValue().set(key, "NULL", Duration.ofMinutes(5));
            return null;
        }
        redisTemplate.opsForValue().set(key, user, Duration.ofHours(1));
    }

    return "NULL".equals(user) ? null : user;
}
```

### 2. ç¼“å­˜å‡»ç©¿

```java
// è§£å†³æ–¹æ¡ˆï¼šäº’æ–¥é” + åŒé‡æ£€æŸ¥
public Object getDataWithMutex(String key) {
    Object data = redisTemplate.opsForValue().get(key);
    if (data != null) {
        return data;
    }

    synchronized (this) {
        // åŒé‡æ£€æŸ¥
        data = redisTemplate.opsForValue().get(key);
        if (data != null) {
            return data;
        }

        // æŸ¥è¯¢æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜
        data = queryFromDatabase(key);
        if (data != null) {
            redisTemplate.opsForValue().set(key, data, Duration.ofHours(1));
        }
    }

    return data;
}
```

---

*é€šè¿‡è¿™äº›å®æˆ˜ç»éªŒå’Œæœ€ä½³å®è·µï¼Œä½ å¯ä»¥åœ¨é¢è¯•ä¸­å±•ç°å¯¹ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜çš„æ·±åº¦ç†è§£ï¼ŒåŒæ—¶åœ¨å®é™…é¡¹ç›®ä¸­æ„å»ºæ›´åŠ å¯é å’Œé«˜æ•ˆçš„ç¼“å­˜ç³»ç»Ÿã€‚*
